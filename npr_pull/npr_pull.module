<?php

/**
 * @file
 * Helper functions for the NPR API module.
 */

use Drupal\user\Entity\User;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * @see npr_pull_form_npr_api_config_form_submit().
 */
function npr_pull_form_npr_api_config_form_alter(&$form, &$form_state, $form_id) {

  $pull_config = \Drupal::config('npr_pull.settings');

  // Add a NPR Pull section to the API Settings configuration page.
  $form['npr_pull_config'] = [
    '#type' => 'fieldset',
    '#title' => t('NPR Pull'),
  ];
  $form['npr_pull_config']['npr_pull_url'] = [
    '#type' => 'select',
    '#title' => t('NPR Pull URL'),
    '#default_value' => $pull_config->get('npr_pull_url'),
    '#options' => [
      'staging' => 'Staging',
      'production' => 'Production',
    ],
  ];

  // Create an array of all Drupal users.
  $users = User::loadMultiple();
  $all_users = [];
  foreach ($users as $user) {
    $all_users[$user->id()] = $user->getDisplayName();
  }
  unset($all_users[0]);
  asort($all_users);

  $form['npr_pull_config']['npr_pull_author'] = [
    '#type' => 'select',
    '#title' => 'Drupal author of pulled stories',
    '#default_value' => $pull_config->get('npr_pull_author'),
    '#options' => $all_users,
  ];

  $form['story_queue'] = [
    '#type' => 'details',
    '#title' => t('Stories queue settings'),
    '#open' => TRUE,
  ];

  $form['story_queue']['queue_enable'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable automated queue building'),
    '#description' => t('Enable incremental updates to local Story
      nodes from NPR API data.'),
    '#default_value' => $pull_config->get('queue_enable'),
    '#return_value' => TRUE,
  ];

  $interval_options = [3600, 10800, 21600, 43200, 86400, 604800];
  /** @var \Drupal\Core\Datetime\DateFormatterInterface $date_formatter */
  $date_formatter = \Drupal::service('date.formatter');
  $form['story_queue']['queue_interval'] = [
    '#type' => 'select',
    '#title' => t('Queue builder update interval'),
    '#description' => t('How often to check the NPR API for new or
      updated stories to add to the queue. The queue itself is processed
      one every cron ron (or by an external cron operation).'),
    '#default_value' => $pull_config->get('queue_interval'),
    '#options' => array_map([$date_formatter, 'formatInterval'],
      array_combine($interval_options, $interval_options)
    ),
    '#states' => [
      'visible' => [
        'input[name="queue_enable"]' => ['checked' => TRUE],
      ],
    ],
  ];

  $form['#submit'][] = 'npr_pull_form_npr_api_config_form_submit';
}

/**
 * Submit handler for the form_alter().
 */
function npr_pull_form_npr_api_config_form_submit(array &$form, FormStateInterface $form_state) {
  $config_factory = \Drupal::configFactory();
  $config = $config_factory->getEditable('npr_pull.settings');
  $values = $form_state->getValues();
  $config->set('npr_pull_url', $values['npr_pull_url']);
  $config->set('npr_pull_author', $values['npr_pull_author']);
  $config->set('queue_interval', $values['queue_interval']);
  $config->set('queue_enable', $values['queue_enable']);
  $config->save();
}
