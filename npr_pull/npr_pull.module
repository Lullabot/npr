<?php

/**
 * @file
 * Helper functions for the NPR API module.
 */

/**
 * Implements hook_cron().
 *
 * @see \Drupal\npr_pull\Plugin\QueueWorker\StoryQueueWorker
 *
 * @throws \Exception
 */
function npr_pull_cron(): void {
  /** @var \Drupal\Core\Config\ConfigFactoryInterface $config_factory */
  $config_factory = \Drupal::configFactory();
  $config = $config_factory->get('npr_pull.settings');

  // Get the current time.
  $request_time = \Drupal::time()->getRequestTime();
  $now = new DateTime("@{$request_time}");

  if ($config->get('queue_interval')) {
    /** @var \Drupal\npr_pull\NprPullClient $nprPullClient */
    $nprPullClient = Drupal::service('npr_pull.client');

    // Get a timestamp of the update interval.
    $interval = (int) $config->get('queue_interval');
    // Determine difference beteween now and when the queue was last updated.
    $diff = $now->getTimestamp() - $nprPullClient->getLastUpdateTime()->getTimestamp();

    // Only update the queue if more time has passed than the desired interval.
    if ($diff > $interval) {
      _npr_pull_story_update_queue();
    }
  }
}

/**
 * Executes the Story queue update operation.
 *
 * @throws \Exception
 */
function _npr_pull_story_update_queue() {
  /** @var \Drupal\npr_pull\NprPullClient $nprPullClient */
  $nprPullClient = Drupal::service('npr_pull.client');
  $nprPullClient->updateQueue();
}
